<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Puzzle</title>

<style>
body{margin:0;background:#111;color:#fff;font-family:Arial;display:flex;flex-direction:column;align-items:center}
#top{padding:10px}
#board{position:relative;background:#000;border:2px solid #333;touch-action:none}
.piece{position:absolute;border:1px solid #222;background-repeat:no-repeat;transition:left .25s,top .25s}
.piece.dragging{transition:none;z-index:10}
.piece.locked{border:none}
.buffer-line{position:absolute;left:0;right:0;border-top:2px dashed #555}
#win{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;
font-size:32px;opacity:0;pointer-events:none;transition:.3s}
#win.show{opacity:1}
</style>
</head>

<body>

<div id="top"><input type="file" id="file" accept="image/*"></div>
<div id="board"></div>
<div id="win">ðŸŽ‰ Tebrikler! Puzzle TamamlandÄ±</div>

<script>
/* ===== AYAR ===== */
var ROWS=3, COLS=5, BUFFER=1;

/* ===== STATE ===== */
var PW,PH;
var pieces=[], groups={};
var dragging=null, pointerId=null, ox=0, oy=0;

/* ===== DOM ===== */
var board=document.getElementById("board");
var input=document.getElementById("file");

/* ===== FOTO ===== */
input.onchange=function(){
  var f=input.files[0]; if(!f) return;
  var r=new FileReader();
  r.onload=function(e){ init(e.target.result); };
  r.readAsDataURL(f);
};

function init(src){
  board.innerHTML="";
  pieces=[]; groups={};

  var img=new Image();
  img.onload=function(){
    var W=Math.floor(innerWidth*0.95);
    var H=W*(img.height/img.width);
    PW=W/COLS; PH=H/ROWS;

    board.style.width=W+"px";
    board.style.height=PH*(ROWS+BUFFER)+"px";

    var bl=document.createElement("div");
    bl.className="buffer-line";
    bl.style.top=(PH*ROWS)+"px";
    board.appendChild(bl);

    var cells=[];
    for(var y=0;y<ROWS+BUFFER;y++)
      for(var x=0;x<COLS;x++)
        cells.push({x:x,y:y});
    cells.sort(function(){return Math.random()-0.5});

    var gid=0;
    for(var ry=0;ry<ROWS;ry++){
      for(var rx=0;rx<COLS;rx++){
        var c=cells.pop();
        var el=document.createElement("div");
        el.className="piece";
        el.style.width=PW+"px";
        el.style.height=PH+"px";
        el.style.backgroundImage="url("+src+")";
        el.style.backgroundSize=W+"px "+H+"px";
        el.style.backgroundPosition=(-rx*PW)+"px "+(-ry*PH)+"px";
        el.style.left=(c.x*PW)+"px";
        el.style.top =(c.y*PH)+"px";
        board.appendChild(el);

        var p={el:el,cx:rx,cy:ry,x:c.x,y:c.y,locked:false,gid:gid};
        pieces.push(p); groups[gid]=[p]; gid++;

        el.onpointerdown=(function(pp){
          return function(e){ startDrag(e,pp); };
        })(p);
      }
    }
  };
  img.src=src;
}

/* ===== DRAG ===== */
function startDrag(e,p){
  if(p.locked||pointerId!==null) return;
  pointerId=e.pointerId;
  dragging=groups[p.gid];
  var r=p.el.getBoundingClientRect();
  ox=e.clientX-r.left; oy=e.clientY-r.top;
  dragging.forEach(function(q){q.el.classList.add("dragging");});
  p.el.setPointerCapture(pointerId);
}

board.onpointermove=function(e){
  if(!dragging||e.pointerId!==pointerId) return;
  var base=dragging[0];
  dragging.forEach(function(p){
    p.el.style.left=e.clientX-board.offsetLeft-ox+(p.x-base.x)*PW+"px";
    p.el.style.top =e.clientY-board.offsetTop -oy+(p.y-base.y)*PH+"px";
  });
};

board.onpointerup=drop;
board.onpointercancel=drop;

/* ===== DROP (STABÄ°L) ===== */
function drop(){
  if(!dragging) return;

  var base=dragging[0];
  var tx=Math.round(base.el.offsetLeft/PW);
  var ty=Math.round(base.el.offsetTop /PH);

  var targets=[];
  dragging.forEach(function(p){
    targets.push({p:p,x:tx+(p.x-base.x),y:ty+(p.y-base.y)});
  });

  var grid=buildGrid(dragging);

  targets.forEach(function(t){
    var occ=grid[t.y]&&grid[t.y][t.x];
    if(occ){
      if(occ.locked){
        var alt=findEmpty(grid);
        t.x=alt.x; t.y=alt.y;
      }else{
        moveToEmpty(occ,grid);
      }
    }
  });

  targets.forEach(function(t){
    t.p.x=t.x; t.p.y=t.y;
    grid[t.y][t.x]=t.p;
  });

  pieces.forEach(drawPiece);
  dragging.forEach(function(p){p.el.classList.remove("dragging");});
  dragging=null; pointerId=null;

  lockMergeAndWin();
}

/* ===== GRID ===== */
function buildGrid(ignore){
  var g=[];
  for(var y=0;y<ROWS+BUFFER;y++){
    g[y]=[];
    for(var x=0;x<COLS;x++) g[y][x]=null;
  }
  pieces.forEach(function(p){
    if(ignore.indexOf(p)!==-1) return;
    g[p.y][p.x]=p;
  });
  return g;
}

/* ===== BOÅž YER ===== */
function findEmpty(grid){
  for(var x=0;x<COLS;x++) if(!grid[ROWS][x]) return {x:x,y:ROWS};
  for(var y=0;y<ROWS;y++)
    for(var x2=0;x2<COLS;x2++)
      if(!grid[y][x2]) return {x:x2,y:y};
}

/* ===== KAYDIR ===== */
function moveToEmpty(p,grid){
  var e=findEmpty(grid);
  grid[p.y][p.x]=null;
  p.x=e.x; p.y=e.y;
  grid[p.y][p.x]=p;
}

function drawPiece(p){
  p.el.style.left=(p.x*PW)+"px";
  p.el.style.top =(p.y*PH)+"px";
}

/* ===== LOCK + MERGE + WIN ===== */
function lockMergeAndWin(){
  pieces.forEach(function(p){
    if(!p.locked && p.x===p.cx && p.y===p.cy){
      p.locked=true;
      p.el.classList.add("locked");
    }
  });

  for(var i=0;i<pieces.length;i++){
    for(var j=0;j<pieces.length;j++){
      var a=pieces[i], b=pieces[j];
      if(a.gid===b.gid||!a.locked||!b.locked) continue;
      var right=a.cx+1===b.cx && a.x+1===b.x && a.y===b.y;
      var down =a.cy+1===b.cy && a.y+1===b.y && a.x===b.x;
      if(right||down){
        groups[b.gid].forEach(function(p){
          p.gid=a.gid; groups[a.gid].push(p);
        });
        delete groups[b.gid];
        break;
      }
    }
  }

  if(pieces.every(function(p){return p.locked;})){
    document.getElementById("win").classList.add("show");
  }
}
</script>
</body>
</html>
