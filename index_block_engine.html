<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Block Puzzle Engine</title>

<style>
body{margin:0;background:#111;color:#fff;font-family:Arial;display:flex;flex-direction:column;align-items:center}
#top{padding:10px}
#board{position:relative;background:#000;border:2px solid #333;touch-action:none}
.block-piece{position:absolute;border:1px solid #222;background-repeat:no-repeat;transition:left .2s,top .2s}
.block-piece.dragging{transition:none;z-index:10}
</style>
</head>

<body>

<div id="top"><input type="file" id="file" accept="image/*"></div>
<div id="board"></div>

<script>
/* ===== CONFIG ===== */
var ROWS=3, COLS=5;

/* ===== STATE ===== */
var PW,PH;
var blocks=[];
var draggingBlock=null;
var pointerId=null;
var ox=0,oy=0;

var board=document.getElementById("board");
var input=document.getElementById("file");

/* ===== IMAGE LOAD ===== */
input.onchange=function(){
  var f=input.files[0];
  if(!f) return;
  var r=new FileReader();
  r.onload=function(e){ init(e.target.result); };
  r.readAsDataURL(f);
};

function init(src){
  board.innerHTML="";
  blocks=[];

  var img=new Image();
  img.onload=function(){
    var maxW=innerWidth*0.95;
    var maxH=innerHeight*0.7;
    var ratio=img.width/img.height;
    var W=maxW,H=W/ratio;
    if(H>maxH){H=maxH;W=H*ratio;}

    PW=W/COLS; PH=H/ROWS;
    board.style.width=W+"px";
    board.style.height=H+"px";

    var id=0;
    for(var y=0;y<ROWS;y++){
      for(var x=0;x<COLS;x++){
        var el=document.createElement("div");
        el.className="block-piece";
        el.style.width=PW+"px";
        el.style.height=PH+"px";
        el.style.backgroundImage="url("+src+")";
        el.style.backgroundSize=W+"px "+H+"px";
        el.style.backgroundPosition=(-x*PW)+"px "+(-y*PH)+"px";
        board.appendChild(el);

        var piece={cx:x,cy:y,x:x,y:y,el:el};
        var block={id:id,pieces:[piece]};
        blocks.push(block); id++;

        el.onpointerdown=(function(b,p){
          return function(e){ startDrag(e,b,p); };
        })(block,piece);
      }
    }

    shuffle();
    draw();
  };
  img.src=src;
}

/* ===== SHUFFLE ===== */
function shuffle(){
  var cells=[];
  for(var y=0;y<ROWS;y++)
    for(var x=0;x<COLS;x++)
      cells.push({x:x,y:y});
  cells.sort(function(){return Math.random()-0.5});
  blocks.forEach(function(b,i){
    b.pieces[0].x=cells[i].x;
    b.pieces[0].y=cells[i].y;
  });
}

/* ===== DRAG ===== */
function startDrag(e,block,piece){
  if(pointerId!==null) return;
  pointerId=e.pointerId;
  draggingBlock=block;

  var r=piece.el.getBoundingClientRect();
  ox=e.clientX-r.left;
  oy=e.clientY-r.top;

  block.pieces.forEach(function(p){p.el.classList.add("dragging");});
  piece.el.setPointerCapture(pointerId);
}

board.onpointermove=function(e){
  if(!draggingBlock||e.pointerId!==pointerId) return;
  var rect=board.getBoundingClientRect();
  var base=draggingBlock.pieces[0];

  draggingBlock.pieces.forEach(function(p){
    p.el.style.left=(e.clientX-rect.left-ox+(p.x-base.x)*PW)+"px";
    p.el.style.top =(e.clientY-rect.top -oy+(p.y-base.y)*PH)+"px";
  });
};

board.onpointerup=endDrag;
board.onpointercancel=endDrag;

/* ===== DROP (FOOTPRINT SAFE) ===== */
function endDrag(){
  if(!draggingBlock) return;

  var base=draggingBlock.pieces[0];
  var nx=Math.round(base.el.offsetLeft/PW);
  var ny=Math.round(base.el.offsetTop /PH);

  var targets=draggingBlock.pieces.map(function(p){
    return {p:p,x:nx+(p.x-base.x),y:ny+(p.y-base.y)};
  });

  var occ=buildOcc();

  // ÇAKIŞAN BLOCKLARI TESPİT ET
  var conflicts=[];
  targets.forEach(function(t){
    var b=occ[t.y]&&occ[t.y][t.x];
    if(b && b!==draggingBlock && conflicts.indexOf(b)===-1){
      conflicts.push(b);
    }
  });

  // HER ÇAKIŞAN BLOCK'U GÜVENLİ YERE TAŞI
  conflicts.forEach(function(b){
    var pos=findSafePosition(b,occ);
    if(pos){
      moveBlock(b,pos,occ);
    }
  });

  // Drag edilen block için alan hâlâ doluysa → GERİ AL
  for(var i=0;i<targets.length;i++){
    if(occ[targets[i].y][targets[i].x]){
      draggingBlock.pieces.forEach(function(p){
        p.el.classList.remove("dragging");
      });
      draggingBlock=null; pointerId=null;
      draw();
      return;
    }
  }

  // YERLEŞTİR
  targets.forEach(function(t){
    t.p.x=t.x; t.p.y=t.y;
  });

  draggingBlock.pieces.forEach(function(p){
    p.el.classList.remove("dragging");
  });

  draggingBlock=null;
  pointerId=null;

  merge();
  draw();
}

/* ===== OCCUPANCY ===== */
function buildOcc(){
  var o=[];
  for(var y=0;y<ROWS;y++){
    o[y]=[];
    for(var x=0;x<COLS;x++) o[y][x]=null;
  }
  blocks.forEach(function(b){
    b.pieces.forEach(function(p){
      o[p.y][p.x]=b;
    });
  });
  return o;
}

/* ===== SAFE POSITION ===== */
function findSafePosition(block,occ){
  for(var y=0;y<ROWS;y++){
    for(var x=0;x<COLS;x++){
      var ok=true;
      for(var i=0;i<block.pieces.length;i++){
        var p=block.pieces[i];
        var tx=x+(p.x-block.pieces[0].x);
        var ty=y+(p.y-block.pieces[0].y);
        if(tx<0||tx>=COLS||ty<0||ty>=ROWS||occ[ty][tx]){
          ok=false; break;
        }
      }
      if(ok) return {x:x,y:y};
    }
  }
  return null;
}

function moveBlock(block,pos,occ){
  var base=block.pieces[0];
  block.pieces.forEach(function(p){
    p.x=pos.x+(p.x-base.x);
    p.y=pos.y+(p.y-base.y);
  });
}

/* ===== MERGE ===== */
function merge(){
  for(var i=0;i<blocks.length;i++){
    for(var j=0;j<blocks.length;j++){
      if(i===j) continue;
      if(canMerge(blocks[i],blocks[j])){
        blocks[i].pieces=blocks[i].pieces.concat(blocks[j].pieces);
        blocks.splice(j,1);
        return merge();
      }
    }
  }
}

function canMerge(A,B){
  for(var i=0;i<A.pieces.length;i++){
    for(var j=0;j<B.pieces.length;j++){
      var a=A.pieces[i], b=B.pieces[j];
      var r=a.cx+1===b.cx && a.x+1===b.x && a.y===b.y;
      var d=a.cy+1===b.cy && a.y+1===b.y && a.x===b.x;
      if(r||d) return true;
    }
  }
  return false;
}

/* ===== DRAW ===== */
function draw(){
  blocks.forEach(function(b){
    b.pieces.forEach(function(p){
      p.el.style.left=(p.x*PW)+"px";
      p.el.style.top =(p.y*PH)+"px";
    });
  });
}
</script>

</body>
</html>
